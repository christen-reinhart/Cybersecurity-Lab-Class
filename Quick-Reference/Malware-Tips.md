# üîé SANS Tips for Reverse-Engineering Malicious Code

**Author**: Lenny Zeltser (with feedback from Anuj Soni)  
**Course**: SANS FOR610 ‚Äì Reverse-Engineering Malware  
**Version**: 1.1  
**License**: Creative Commons v3 ‚ÄúAttribution‚Äù

---

## üß≠ Code Analysis Process Overview

1. Examine static properties of the executable (initial triage).
2. Identify strings and API calls indicating malicious capabilities.
3. Conduct automated/manual behavioral analysis for more insight.
4. Emulate execution to pinpoint key functionality.
5. Use a disassembler/decompiler to analyze static code paths.
6. Use a debugger for dynamic analysis of suspicious logic.
7. If packed, unpack the code and artifacts.
8. Annotate: add comments, rename variables/functions.
9. Expand into related referenced/dependent code.
10. Repeat steps 5‚Äì9 as needed to meet objectives.

---

## üß† Common 32-Bit Registers

| Register | Use |
|----------|-----|
| EAX | Addition, multiplication, return values |
| ECX | Counter (e.g., for LOOP) |
| EBP | Frame pointer (args = EBP+val, locals = EBP-val) |
| ESP | Top of stack (modified by PUSH/POP) |
| EIP | Instruction pointer (next instruction) |
| EFLAGS | Flags from comparisons (e.g., Zero, Carry) |
| FS | Segment register; FS[0] = SEH chain, FS[0x30] = PEB |

---

## üî£ Common x86 Assembly Instructions

```asm
mov EAX, 0xB8        ; Set EAX to 0xB8
push EAX             ; Push EAX to stack
pop EAX              ; Pop stack to EAX
lea EAX, [EBP-4]     ; Load address into EAX
call EAX             ; Call function in EAX
add ESP, 8           ; Shrink stack (2 args)
sub ESP, 0x54        ; Reserve local stack space
xor EAX, EAX         ; Zero EAX
test EAX, EAX        ; Set flags for comparison
cmp EAX, 0xB8        ; Compare EAX to 0xB8
```

---

## üß† Understanding 64-Bit Registers

- EAX ‚Üí RAX, ECX ‚Üí RCX, ESP ‚Üí RSP, etc.
- New: R8‚ÄìR15
- RSP used instead of EBP for locals and args
- Sub-registers:
  - `R8B` (8-bit), `R8W` (16-bit), `R8D` (32-bit), `R8` (64-bit)

---

## üì¶ Passing Parameters to Functions

| Arg | 32-bit | 64-bit |
|-----|--------|--------|
| arg0 | `[EBP+8]` | `RCX` |
| arg1 | `[EBP+0xC]` | `RDX` |
| arg2 | `[EBP+0x10]` | `R8` |
| arg3 | `[EBP+0x14]` | `R9` |

---

## üîÅ Conditional Jumps (x86)

| Instruction | Meaning |
|-------------|---------|
| `JA`, `JG` | Jump if above / greater |
| `JB`, `JL` | Jump if below / less |
| `JE`, `JZ` | Jump if equal / zero |
| `JNE`, `JNZ` | Jump if not equal / not zero |
| `JGE`, `JNL` | Jump if greater or equal / not less |

---

## ‚ö†Ô∏è Risky Windows API Calls

### Code Injection
- `CreateRemoteThread`, `OpenProcess`, `VirtualAllocEx`, `WriteProcessMemory`, `EnumProcesses`

### DLL Loading
- `LoadLibrary`, `GetProcAddress`

### Memory Scraping
- `CreateToolhelp32Snapshot`, `ReadProcessMemory`

### Info Theft
- `GetClipboardData`, `GetWindowText`

### Keylogging
- `GetAsyncKeyState`, `SetWindowsHookEx`

### Resource Extraction
- `FindResource`, `LockResource`

### Unpacking / Self-Injection
- `VirtualAlloc`, `VirtualProtect`

### Environment Artifacts
- `CreateMutex`, `CreateFile`, `FindWindow`, `GetModuleHandle`, `RegOpenKeyEx`

### Execution
- `WinExec`, `ShellExecute`, `CreateProcess`

### Networking
- `InternetOpen`, `HttpOpenRequest`, `HttpSendRequest`, `InternetReadFile`

---

## üìù Additional Analysis Tips

- Be patient; focus on small manageable code blocks.
- Use a debugger when static reversing is too complex.
- Track jumps and calls to understand execution flow.
- If static analysis stalls, try behavioral/memory analysis.
- Learn both official and native (Nt, Zw, Rtl) API names.

---

## üîó References

- [https://zeltser.com](https://zeltser.com)
- [https://malwology.com](https://malwology.com)
- [https://www.sans.org/cyber-security-courses/reverse-engineering-malware-malware-analysis-tools-techniques/](https://www.sans.org/cyber-security-courses/reverse-engineering-malware-malware-analysis-tools-techniques/)
- [https://creativecommons.org/licenses/by/3.0/](https://creativecommons.org/licenses/by/3.0/)
- [https://zeltser.com/cheat-sheets/](https://zeltser.com/cheat-sheets/)

---

**Converted to Markdown by: Christen Reinhart**  
**Original Author: Lenny Zeltser**
